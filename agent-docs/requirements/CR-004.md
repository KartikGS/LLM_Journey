# CR-004: E2E Suite Stabilization and Browser Compatibility Fix

## 1. Business Value
Ensures the reliability of the automated testing suite, allowing developers to trust CI results and preventing regression in Webkit-based environments (Safari).

## 2. Problem Statement
The E2E test suite currently suffers from:
1.  **Inconsistency**: Parallel execution overloads the dev server, causing false negatives in navigation tests.
2.  **Webkit Regression**: Security headers designed for production prevent Webkit from loading the app on `localhost`.

## Status: Completed

## 3. Acceptance Criteria (AC)
- [x] `pnpm test:e2e` passes consistently across all browsers (Chromium, Firefox, Webkit) when run together.
- [x] Webkit tests no longer display a "white screen" and correctly render the landing page.
- [x] Middleware rate limiting does not block legitimate telemetry from local E2E tests.
- [x] E2E tests can be run at least twice in a row without needing a server restart (idempotency).

## 4. Constraints & Technical Context
-   **Security**: Must ensure `upgrade-insecure-requests` remains active in production but disabled in dev.
-   **Performance**: Do not increase global timeouts excessively; prioritize fixing the underlying contention.
-   **Dependencies**: Maintain compatibility with `onnxruntime-web` and `BrowserGuard`.

## 5. Risk Analysis
-   **Production Parity**: Disabling security headers in dev might mask header-related issues that could occur in production. *Mitigation: Keep production CSP strict.*
-   **CI Runtime**: Reducing workers increases test duration. *Mitigation: Use more workers only on high-spec CI environments.*

## 6. References
-   [E2E Issue Analysis Report](../reports/E2E-issue-analysis.md)
-   `middleware.ts` (CSP & Rate Limiting)
-   `playwright.config.ts` (Worker configuration)
-   `components/ui/browser-support-fallback.tsx` (BrowserGuard)
