// Grafana Alloy configuration for log shipping to Loki
// Collects logs from local file (Next.js dev) and ships to Loki

// Source: tail log file from mounted volume
local.file_match "app_logs" {
  path_targets = [
    {
      "__path__" = "/logs/*.log",
      "job"      = "llm-journey",
      "source"   = "nextjs",
    },
  ]
}

loki.source.file "app_logs" {
  targets    = local.file_match.app_logs.targets
  forward_to = [loki.process.app_logs.receiver]
}

// Process logs: parse JSON (pino format) and extract fields
loki.process "app_logs" {
  forward_to = [loki.write.loki.receiver]

  // Parse JSON logs (pino format)
  stage.json {
    expressions = {
      level       = "level",
      msg         = "msg",
      service     = "service_name",
      trace_id    = "trace_id",
      span_id     = "span_id",
      time        = "time",
    }
  }

  // Add extracted values as labels
  stage.labels {
    values = {
      service  = "",
      trace_id = "",
      span_id  = "",
    }
  }

  // Convert pino numeric level to string label
  stage.match {
    selector = "{}"
    stage.template {
      source   = "level_name"
      template = "{{ if eq .level \"10\" }}trace{{ else if eq .level \"20\" }}debug{{ else if eq .level \"30\" }}info{{ else if eq .level \"40\" }}warn{{ else if eq .level \"50\" }}error{{ else if eq .level \"60\" }}fatal{{ else }}unknown{{ end }}"
    }
    stage.labels {
      values = {
        level = "level_name",
      }
    }
  }

  // Use message as the log line
  stage.output {
    source = "msg"
  }
}

// Write logs to Loki
loki.write "loki" {
  endpoint {
    url = "http://loki:3100/loki/api/v1/push"
  }
}
